# Expectimax Agent 参数调优指南

本文档说明如何调整 Expectimax Agent 的参数来优化性能。

## 📊 参数分类

### 1. **Agent 初始化参数**（在 `__init__` 中设置）

这些参数在创建 Agent 时设置，影响搜索策略：

#### `depth` (搜索深度)
- **当前值**: 3
- **建议范围**: 2-5
- **影响**:
  - ✅ **增加** (4-5): 更准确的决策，但计算时间指数级增长
  - ✅ **减少** (2): 更快响应，但可能不够深入
- **推荐**: 
  - 快速模式: `depth=2`
  - 平衡模式: `depth=3` (默认)
  - 精确模式: `depth=4` (如果电脑性能好)

#### `max_chance_branches` (Chance 节点分支数)
- **当前值**: 6
- **建议范围**: 4-10
- **影响**:
  - ✅ **增加** (8-10): 更准确评估随机性，但更慢
  - ✅ **减少** (4-5): 更快，但可能忽略重要情况
- **推荐**: 
  - 快速模式: `max_chance_branches=4`
  - 平衡模式: `max_chance_branches=6` (默认)
  - 精确模式: `max_chance_branches=8`

#### `sample_chance` (采样模式)
- **当前值**: False
- **选项**: True / False
- **影响**:
  - ✅ **True**: 随机采样，更快但有随机性
  - ✅ **False**: 智能选择危险位置，更保守但更稳定
- **推荐**: `False` (更稳定，推荐)

---

### 2. **启发式函数权重**（在 `HEURISTIC_WEIGHTS` 字典中）

这些参数影响局面评估的准确性：

#### `empty` (空格权重)
- **当前值**: 1200
- **建议范围**: 1000-1500
- **说明**: 空格数量是最重要的因素
- **调优建议**:
  - 如果 agent 过早填满空格 → **增加** (1300-1500)
  - 如果 agent 不够重视空格 → **减少** (1000-1100)

#### `max_tile` (最大块权重)
- **当前值**: 250
- **建议范围**: 200-300
- **说明**: 鼓励追求更大的数字
- **调优建议**:
  - 如果 agent 不够积极追求大数字 → **增加** (280-300)
  - 如果 agent 过于激进 → **减少** (200-220)

#### `smooth` (平滑度权重)
- **当前值**: 8
- **建议范围**: 5-15
- **说明**: 鼓励相邻格子数值接近
- **调优建议**:
  - 如果局面太混乱 → **增加** (10-15)
  - 如果过于保守 → **减少** (5-7)

#### `mono_h` / `mono_v` (单调性权重)
- **当前值**: 3 (行和列)
- **建议范围**: 2-5
- **说明**: 鼓励行列单调排列（便于合并）
- **调优建议**:
  - 如果合并机会少 → **增加** (4-5)
  - 如果过于追求单调 → **减少** (2-2.5)

#### `corner_main` (主角落权重)
- **当前值**: 10
- **建议范围**: 8-15
- **说明**: 鼓励大数字在左上角
- **调优建议**:
  - 如果大数字不在角落 → **增加** (12-15)
  - 如果过于依赖角落 → **减少** (8-9)

#### `corner_other` (其他角落权重)
- **当前值**: 3
- **建议范围**: 2-5
- **说明**: 其他角落的奖励（较低）

#### `merge_potential` (合并潜力权重)
- **当前值**: 15
- **建议范围**: 10-20
- **说明**: 奖励可能的合并机会
- **调优建议**:
  - 如果错过合并机会 → **增加** (18-20)
  - 如果过于追求合并 → **减少** (10-12)

#### `special_penalty` (特殊格子惩罚)
- **当前值**: 5
- **建议范围**: 3-8
- **说明**: 惩罚特殊格子上的大数字（可能被减半）
- **调优建议**:
  - 如果特殊格子影响太大 → **增加** (6-8)
  - 如果过于保守 → **减少** (3-4)

---

### 3. **危险位置评估参数**（在 `DANGER_PARAMS` 字典中）

这些参数影响 chance 节点如何选择评估位置：

#### `corner_danger` (角落危险分数)
- **当前值**: 3
- **建议范围**: 2-5
- **说明**: 角落位置的危险程度
- **调优建议**: 一般不需要修改

#### `edge_danger` (边缘危险分数)
- **当前值**: 1
- **建议范围**: 1-2
- **说明**: 边缘位置的危险程度

#### `big_neighbor_threshold` (大数字邻居阈值)
- **当前值**: 8
- **建议范围**: 4-16
- **说明**: 多大算"大数字"
- **调优建议**:
  - 如果早期阶段评估不够 → **减少** (4-6)
  - 如果后期阶段评估过多 → **增加** (12-16)

#### `big_neighbor_penalty` (大数字邻居惩罚)
- **当前值**: 2
- **建议范围**: 1-3
- **说明**: 周围有大数字时的额外危险分数

---

## 🎯 快速调优建议

### 场景 1: Agent 太慢
```python
# 在 puzzle.py 中修改 Agent 初始化
self.agent = ExpectimaxAgent(
    depth=2,                    # 减少深度
    max_chance_branches=4,      # 减少分支
    sample_chance=True          # 使用采样模式
)
```

### 场景 2: Agent 不够准确
```python
self.agent = ExpectimaxAgent(
    depth=4,                    # 增加深度
    max_chance_branches=8,      # 增加分支
    sample_chance=False         # 使用智能选择
)
```

### 场景 3: Agent 过早失败（空格太少）
```python
# 在 agent_Expectimax.py 中修改
HEURISTIC_WEIGHTS = {
    'empty': 1500,              # 增加空格权重
    # ... 其他保持不变
}
```

### 场景 4: Agent 不够积极（最大块太小）
```python
HEURISTIC_WEIGHTS = {
    'max_tile': 300,            # 增加最大块权重
    'corner_main': 15,          # 增加角落权重
    # ... 其他保持不变
}
```

### 场景 5: Agent 错过合并机会
```python
HEURISTIC_WEIGHTS = {
    'merge_potential': 20,       # 增加合并潜力权重
    'mono_h': 4,                # 增加单调性权重
    'mono_v': 4,
    # ... 其他保持不变
}
```

---

## 📈 调优流程

1. **确定问题**: 观察 agent 的表现，找出主要问题
   - 太慢？
   - 过早失败？
   - 不够积极？
   - 错过合并？

2. **调整参数**: 根据问题调整相应参数（一次只调 1-2 个）

3. **测试验证**: 运行多局游戏，记录：
   - 平均步数
   - 最大块
   - 胜率
   - 计算时间

4. **迭代优化**: 根据结果微调参数

---

## 💡 参数优先级

**最重要**（影响最大）:
1. `depth` - 搜索深度
2. `empty` - 空格权重
3. `max_chance_branches` - 分支数

**次重要**:
4. `max_tile` - 最大块权重
5. `corner_main` - 角落权重
6. `merge_potential` - 合并潜力

**微调**:
7. `smooth` - 平滑度
8. `mono_h/v` - 单调性
9. 其他参数

---

## ⚠️ 注意事项

1. **不要同时调整太多参数** - 一次调整 1-2 个，观察效果
2. **参数之间有关联** - 调整一个可能影响其他方面
3. **测试要充分** - 至少运行 10-20 局游戏再下结论
4. **平衡是关键** - 准确性和速度需要权衡

---

## 🔧 如何修改参数

### 方法 1: 直接修改代码
在 `agent_Expectimax.py` 中找到对应的参数字典，直接修改数值。

### 方法 2: 在 puzzle.py 中传递参数
```python
# 在 puzzle.py 的 _build_agent 方法中
def _build_agent(self):
    ai_type = self.ai_type_var.get()
    if ai_type == "Expectimax":
        return ExpectimaxAgent(
            depth=4,                    # 自定义深度
            special_pos=self.special_cell_pos,
            max_chance_branches=8      # 自定义分支数
        )
    return MinimaxAgent(...)
```

---

## 📝 记录建议

建议创建一个表格记录调优过程：

| 参数组合 | 平均步数 | 最大块 | 胜率 | 速度 | 备注 |
|---------|---------|--------|------|------|------|
| 默认值 | ... | ... | ... | ... | 基准 |
| depth=4 | ... | ... | ... | ... | 更准确但慢 |
| empty=1500 | ... | ... | ... | ... | 更重视空格 |

这样可以系统性地找到最佳参数组合。





